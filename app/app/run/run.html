<div class="row">
  <div class="col-sm-1 pad-bot-10">
    <h4 translate>run.title</h4>
  </div>
  <div class="col-sm-2 pad-bot-20 pad-top-5">
    <div class="input-group">
      <select class="form-control" ng-options="type.displayName for type in run.runTypes track by type.name" ng-model="selectedRunType" ng-change="run.warnBeforeDelete('runtype')"></select>
    </div>
  </div>
  <div class="col-sm-5 pad-bot-20 pad-top-10">
    <div class="tab-text">Server Status&nbsp;
      <span ng-show="serverStatuses[selectedRunType.name]=='started'" class="glyphicon glyphicon-ok green-button" aria-label="started"></span>
      <span ng-show="serverStatuses[selectedRunType.name]!='started'" class="glyphicon glyphicon-remove red-button" aria-label="stopped"></span>
   </div>
  </div>
</div>
<div ng-show="selectedRunType.name == 'remote'" class="row">
  <div class="col-sm-12">
    <uib-accordion>
      <uib-accordion-group is-open="remoteSettings.open">
        <uib-accordion-heading>
          <i class="pull-left glyphicon pad-right-5 black-button" ng-class="{'glyphicon-chevron-down': remoteSettings.open, 'glyphicon-chevron-right': !remoteSettings.open}"></i>
          Remote Server Settings
        </uib-accordion-heading>
        <div class="row pad-bot-20">
        <label for="remoteType" class="col-sm-3 run-label">Remote Server Type</label>
          <div class="col-sm-6">
            <select id="remoteType" class="form-control" ng-options="remoteType for remoteType in remoteTypes" ng-model="remoteSettings.remoteType" ng-change="run.OsServer.resetSelectedServerURL()"></select>
          </div>
        </div>
        <div class="row" ng-if="remoteSettings.remoteType == 'Existing Remote Server'">
          <label for="externalURL" class="col-sm-3 run-label">Remote Server URL</label>
          <div class="col-sm-7">
            <input class="form-control" id="externalURL" type="text" ng-model="remoteSettings.remoteServerURL" ng-change="run.resetRemoteServerURL()">
          </div>
          <div class="col-sm-1">
            <button type="button" class="btn btn-primary" ng-show="serverStatuses[selectedRunType.name] != 'started'" ng-click="run.startServer()">Connect</button>
            <button type="button" class="btn btn-danger" ng-show="serverStatuses[selectedRunType.name] == 'started'" ng-click="run.stopServer()">Disconnect</button>
          </div>
        </div>

      </uib-accordion-group>
    </uib-accordion>
  </div>
</div>

<div ng-show="selectedRunType.name == 'remote'" class="row pad-bot-20">
  <div class="col-sm-8">
    <button type="button" class="btn btn-success" ng-show="!disabledButtons" ng-click="run.warnBeforeDelete('run')" translate>run.runEntireWorkflow</button>
    <button type="button" class="btn btn-danger" ng-show="disabledButtons && serverStatuses[selectedRunType.name] == 'started'" ng-click="run.cancelRun()" translate>run.cancelRun</button>
    <button type="button" class="btn btn-primary" ng-show="serverStatuses[selectedRunType.name] == 'started'" ng-click="run.viewServer()">View Server</button>
  </div>
</div>

<div ng-show="selectedRunType.name == 'local'" class="row pad-bot-20">
  <div class="col-sm-12">
    <button type="button" class="btn btn-success" ng-show="!disabledButtons" ng-click="run.warnBeforeDelete('run')" translate>run.runEntireWorkflow</button>
    <button type="button" class="btn btn-danger" ng-show="disabledButtons" ng-click="run.cancelRun()" translate>run.cancelRun</button>
    <button type="button" class="btn btn-danger" ng-show="serverStatuses[selectedRunType.name] == 'started'" ng-click="run.stopServer()" translate>run.stopServer</button>
    <button type="button" class="btn btn-primary" ng-show="serverStatuses[selectedRunType.name] == 'started'" ng-click="run.viewServer()">View Server</button>
  </div>
</div>

<div class="row">
  <div class="col-sm-6">
    <uib-progressbar class="progress-striped active" type="success" value="progress.amount">{{progress.message}}</uib-progressbar>
  </div>
</div>

<div ng-show="analysisID != undefined">
  <div class="row row-borders">
    <div class="col-sm-6 tab-text">
       <label>Analysis ID</label> {{analysisID}}
    </div>
    <div class="col-sm-4 tab-text" ng-if="analysisStatus != ''">
      <label>Status</label> {{analysisStatus}}
    </div>
  </div>
</div>

<div ng-if="datapoints.length > 0" class="run-datapoints">
  <div class="row datapoint-header">
    <div class="col-sm-2">Name</div>
    <div class="col-sm-1">Last Run</div>
    <div class="col-sm-1">Run Time</div>
    <div class="col-sm-1">Status</div>
    <div class="col-sm-1">NAs</div>
    <div class="col-sm-1">Warnings</div>
    <div class="col-sm-1">Errors</div>
    <div class="col-sm-1"><span class="badge white-badge dp-badge" ng-click="$event.preventDefault(); $event.stopPropagation();run.clearAllDatapoints()">C</span> All</div>
    <div class="col-sm-3">
      <div class="row">
        <div class="col-sm-4">
        </div>
        <div class="col-sm-3 pad-left-5">
          <img ng-src="assets/images/osmcloud_white.png" alt="Download all OSMs" ng-click="run.downloadAllOSMs();"/>
        </div>
        <div class="col-sm-4">
          <img ng-src="assets/images/resultcloud_white.png" alt="Download all Results" ng-click="run.downloadAllResults();" />
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-sm-12">
      <uib-accordion close-others="false">
        <uib-accordion-group ng-repeat="datapoint in datapoints" id="{{datapoint.id}}" is-open="datapoint.open">
          <uib-accordion-heading>
            <div class="row datapoint-header">
              <div class="col-sm-2 pad-top-10">
                <i class="pull-left glyphicon pad-right-5 black-button" ng-class="{'glyphicon-chevron-down': datapoint.open, 'glyphicon-chevron-right': !datapoint.open}"></i>
                {{datapoint.name}}
              </div>
              <div class="col-sm-1 pad-top-10">{{run.formatDate(datapoint.updated_at)}}</div>
              <div class="col-sm-1 pad-top-10">{{run.getRunTime(datapoint.started_at, datapoint.completed_at)}}</div>
              <div class="col-sm-1 pad-top-10" ng-class="{'green-text': datapoint.status == 'completed', 'red-text': datapoint.status == 'errored'}">{{datapoint.status}}<br/>{{datapoint.completed_status}}</div>
              <div class="col-sm-1 pad-top-10">{{run.calculateNAs(datapoint)}}</div>
              <div class="col-sm-1 pad-top-10"><span class="badge orange-badge square-badge dp-badge">{{run.calculateWarnings(datapoint)}}</span></div>
              <div class="col-sm-1 pad-top-10"><span class="badge red-badge square-badge dp-badge">{{run.calculateErrors(datapoint)}}</span></div>
              <div class="col-sm-1 pad-top-10">&nbsp;&nbsp;<span class="badge orange-badge dp-badge" ng-click="$event.preventDefault(); $event.stopPropagation();run.clearDatapoint(datapoint)">&nbsp;C&nbsp;</span></div>
              <div class="col-sm-3">
                <div class="row">
                  <div class="col-sm-4">
                    <img ng-src="assets/images/ReportingMeasure_icon_grayed.png" alt="Datapoint Still Running" ng-show="datapoint.downloaded_reports != true" />

                    <div class="btn-group" uib-dropdown auto-close="always" ng-show="datapoint.downloaded_reports">
                      <button id="datapoint_{{datapoint.id}}_reports" type="button" class="btn view-report-button" uib-dropdown-toggle ng-disabled="disabled" ng-click="$event.preventDefault();$event.stopPropagation();">
                        <img ng-src="assets/images/ReportingMeasure_icon.png"  alt="View Reports for datapoint {{datapoint.name}}">
                        <span class="caret"></span>
                      </button>
                      <ul class="dropdown-menu" uib-dropdown-menu role="menu" aria-labelledby="datapoint_{{datapoint.id}}_reports">
                        <li role="menuitem" ng-repeat="result in datapoint.result_files | filter:filterReports"><a href="#" ng-click="$event.preventDefault(); $event.stopPropagation();run.viewReportModal(datapoint, result.attachment_file_name);">{{result.attachment_file_name}}</a></li>
                      </ul>
                    </div>
                  </div>
                  <div class="col-sm-3">
                    <img ng-src="assets/images/osmcloud_blue.png" alt="Download OSM for datapoint {{datapoint.name}}" ng-show="datapoint.status == 'completed' && serverStatuses[selectedRunType.name] == 'started' && !datapoint.downloaded_osm" ng-click="$event.preventDefault(); $event.stopPropagation();run.downloadOSM(datapoint)"/>
                    <span class="glyphicon glyphicon-ok-sign green-button big-cell" ng-show="datapoint.status == 'completed' && datapoint.downloaded_osm"></span>
                  </div>
                  <div class="col-sm-4 pad-left-25">
                    <img ng-src="assets/images/resultcloud_blue.png" alt="Download Results for datapoint {{datapoint.name}}" ng-show="datapoint.status == 'completed' && serverStatuses[selectedRunType.name] == 'started' && !datapoint.downloaded_results" ng-click="$event.preventDefault(); $event.stopPropagation();run.downloadResults(datapoint)"/>
                    <span class="glyphicon glyphicon-ok-sign green-button big-cell" ng-show="datapoint.status == 'completed' && datapoint.downloaded_results"></span>
                  </div>
                </div>
              </div>
            </div>
           <!-- <i class="pull-left glyphicon pad-right-5 black-button" ng-class="{'glyphicon-chevron-down': datapoint.open, 'glyphicon-chevron-right': !datapoint.open}"></i>
            {{datapoint.name}} - status: {{datapoint.status}} - {{datapoint.status_message}}-->
          </uib-accordion-heading>
          <div class="run-measures">
            <div class="panel panel-default full-width no-border">
              <div class="panel-body run-measures">
                <div class="row">
                  <div class="col-sm-6 datapoint-id-display">Datapoint ID: {{datapoint.id}}</div>
                </div>
                <uib-accordion close-others="false">
                  <uib-accordion-group ng-repeat="step in datapoint.steps" id="{{datapoint.id}}-{{step.name}}" is-open="step.open">
                    <uib-accordion-heading>
                      <div class="row measure-accordion pad-bot-10">
                        <div class="col-sm-6 bold">{{step.name}}</div>
                      </div>
                      <div class="row measure-accordion">
                        <div class="col-sm-2"></div>
                        <div class="col-sm-1">{{run.formatDate(step.result.started_at)}}</div>
                        <div class="col-sm-1">{{run.getRunTime(step.result.started_at, step.result.completed_at)}}</div>
                        <div class="col-sm-1"></div>
                        <div class="col-sm-1"><span ng-if="step.step_result == 'NotApplicable'">NA</span></div>
                        <div class="col-sm-1"><span class="badge orange-badge square-badge">{{step.result.step_warnings.length}}</span></div>
                        <div class="col-sm-1"><span class="badge red-badge square-badge">{{step.result.step_errors.length}}</span></div>
                        <div class="col-sm-1"></div>
                        <div class="col-sm-3"></div>
                      </div>
                    </uib-accordion-heading>
                    <div class="measure-accordion-body">
                      <label>Initial Condition: </label> {{step.result.step_initial_condition}}<br/>
                      <label>Final Condition: </label> {{step.result.step_final_condition}}<br/>
                      <div ng-repeat="item in step.result.step_errors"><span class="red-text">Error: </span>{{item}}</div>
                      <div ng-repeat="item in step.result.step_warnings"><span class="orange-text">Warning: </span>{{item}}</div>
                      <div ng-repeat="item in step.result.step_info"><span class="green-text">Info: </span>{{item}}</div>
                    </div>
                  </uib-accordion-group>
                  <uib-accordion-group>
                    <uib-accordion-heading>
                      <div class="row measure-accordion pad-bot-10">
                        <div class="col-sm-6 bold">EnergyPlus Results</div>
                      </div>
                    </uib-accordion-heading>
                    <div class="measure-accordion-body">
                      <div>
                        {{datapoint.eplusout_err}}
                      </div>
                    </div>
                  </uib-accordion-group>
                </uib-accordion>
              </div>
            </div>
          </div>
        </uib-accordion-group>
      </uib-accordion>
    </div>
  </div>
</div>

<div class="row pad-top-100">
  <div class="col-sm-10">
    <uib-accordion>
      <uib-accordion-group is-open="dev.open">
        <uib-accordion-heading>
          <i class="pull-left glyphicon pad-right-5 black-button" ng-class="{'glyphicon-chevron-down': dev.open, 'glyphicon-chevron-right': !dev.open}"></i>
          Server Troubleshooting
        </uib-accordion-heading>
        <button type="button" class="btn btn-danger" ng-click="run.startServer('local')">Force Start local Server </button>
        <button type="button" class="btn btn-danger" ng-click="run.stopServer('local')">Force Stop local Server </button>
        <button type="button" class="btn btn-primary" ng-click="run.pingServer()">Ping Current Server and Set Status</button>
      </uib-accordion-group>
    </uib-accordion>
  </div>
</div>


